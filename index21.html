<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hands-Free Task Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/chrono-node@2.3.4/dist/chrono.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    #speakBtn.recording, #handsFreeBtn.recording { background: #d32f2f; color: #fff; }
    #stopBtn, #interruptTTSBtn, #muteMicBtn { margin-left: 10px; }
    #transcript { margin-top: 20px; border: 1px solid #ccc; padding: 10px; min-height: 30px; white-space: pre-wrap; }
    #gptAnswer { margin-top: 18px; padding: 10px; background: #f3f3f3; border-radius: 6px; min-height: 30px; }
    #gptLoading { color: #d32f2f; display: none; }
    .category { margin-top: 20px; }
    .category h3 { margin-bottom: 5px; }
    ul { list-style-type: disc; padding-left: 20px; }
    input[type=text] { width: 80%; padding: 8px; font-size: 16px; }
    .api-inputs { margin-bottom: 16px; }
    .api-inputs label { display: block; margin-top: 8px; }
    .task-input { margin-top: 20px; }
    .task-row { display: flex; align-items: center; margin-bottom: 5px; }
    .task-text { flex: 1; }
    .task-controls { display: flex; align-items: center; gap: 5px; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: #f9f9f9;
      min-width: 100px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 4px;
      overflow: hidden;
    }
    .dropdown-content button {
      color: black;
      padding: 8px 12px;
      text-align: left;
      text-decoration: none;
      display: block;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      cursor: pointer;
    }
    .dropdown-content button:hover {
      background-color: #f1f1f1;
    }
    .dropdown.show .dropdown-content {
      display: block;
    }
    .edit-input {
      width: 80%;
      padding: 3px 6px;
      font-size: 15px;
    }
    .hidden { display: none !important; }
    .date-badge {
      background: #e0e0e0;
      color: #333;
      border-radius: 4px;
      padding: 2px 7px;
      font-size: 12px;
      margin-left: 8px;
    }
    #showAllBtn { margin-top: 10px; margin-bottom: 10px; }
    #exportTasksBtn { margin-top: 16px; }
    #backupArea { margin-top: 8px; font-size: 13px; }
    #interruptTTSBtn, #muteMicBtn { background: #fbc02d; color: #222; }
    #muteMicBtn.muted { background: #bdbdbd; color: #666; }
  </style>
</head>
<body>
  <div class="api-inputs">
    <label>
      OpenAI API Key:
      <input type="text" id="openaiKey" placeholder="Paste your OpenAI API Key" autocomplete="off" />
    </label>
    <label>
      AssemblyAI API Key:
      <input type="text" id="assemblyKey" placeholder="Paste your AssemblyAI API Key" autocomplete="off" />
    </label>
    <button id="saveKeysBtn">Save API Keys</button>
    <span id="apiKeySaved" style="color: green; display: none;">‚úîÔ∏è Saved!</span>
  </div>

  <!-- VOICE DROPDOWN REMOVED -->

  <button id="speakBtn">üéôÔ∏è Speak</button>
  <button id="handsFreeBtn">ü§ñ Hands Free</button>
  <button id="stopBtn" style="display:none;">‚èπÔ∏è Stop Conversation</button>
  <button id="interruptTTSBtn" style="display:none;">‚èπÔ∏è Interrupt Voice</button>
  <button id="muteMicBtn" style="display:none;">üîá Mute Mic</button>
  <span id="gptLoading">Thinking...</span>
  <div id="transcript"></div>
  <div id="gptAnswer"></div>

  <h2>Task Manager with Voice and Manual Input</h2>
  <div class="task-input">
    <input type="text" id="manualInput" placeholder="Enter task and category at end (e.g. Buy milk Shop)" />
    <button id="addManualBtn">Add Task Manually</button>
  </div>
  <button id="showAllBtn" style="display:none;">Show All Tasks</button>
  <div id="categories">
    <div class="category" id="Home">
      <h3>Home</h3>
      <ul></ul>
    </div>
    <div class="category" id="Today">
      <h3>Today</h3>
      <ul></ul>
    </div>
    <div class="category" id="Urgent">
      <h3>Urgent</h3>
      <ul></ul>
    </div>
    <div class="category" id="Shop">
      <h3>Shop</h3>
      <ul></ul>
    </div>
  </div>
  <button id="exportTasksBtn">Export Tasks (Backup)</button>
  <button id="importTasksBtn">Import Tasks</button>
  <textarea id="backupArea" style="width:100%;height:80px;" placeholder="Backup JSON will appear here. Paste here to restore."></textarea>

<script>
/** ---------- CATEGORY CONFIG ---------- **/
const categories = ["Home", "Today", "Urgent", "Shop"];

/** ---------- HANDLE SAMANTHA TTS ONLY ---------- **/
function speakTextWithWebSpeech(text) {
  return new Promise((resolve) => {
    const synth = window.speechSynthesis;
    const speak = () => {
      const utter = new SpeechSynthesisUtterance(text);
      const samantha = synth.getVoices().find(v => v.name && v.name.toLowerCase().includes('samantha'));
      utter.voice = samantha || synth.getVoices()[0] || null;
      utter.pitch = 1; utter.rate = 0.97;
      utter.onend = () => resolve();
      utter.onerror = () => resolve();
      synth.speak(utter);
    };
    if (synth.getVoices().length === 0) {
      synth.onvoiceschanged = speak;
    } else {
      speak();
    }
  });
}

/** ---------- TASK LOAD/SAVE ---------- **/
function saveTasks(category, tasks) {
  localStorage.setItem(category, JSON.stringify(tasks));
}
function loadTasks() {
  categories.forEach(cat => {
    const tasks = JSON.parse(localStorage.getItem(cat)) || [];
    const ul = document.querySelector(`#${cat} ul`);
    ul.innerHTML = "";
    tasks.forEach((taskObj, idx) => {
      const li = document.createElement("li");
      li.style.listStyleType = "none";
      li.appendChild(createTaskRow(cat, taskObj, idx, tasks.length));
      ul.appendChild(li);
    });
  });
}
function saveTask(category, taskObj) {
  const tasks = JSON.parse(localStorage.getItem(category)) || [];
  tasks.push(taskObj);
  saveTasks(category, tasks);
}
function preprocessInput(input) {
  return input.replace(/[\.\,\!\?\;\:]+/g, ' ').replace(/\s+/g, ' ').trim();
}
function extractValidCategory(raw) {
  if (!raw) return null;
  let normalized = raw.toLowerCase();
  normalized = normalized.replace(/[\.\,\!\?\;\:]+/g, '');
  normalized = normalized.replace(/\b(category|list|task|under|from|the|a|an|in|to|for|on|of|as|at|with|by|from|into|onto|and|or|add|new|my)\b/g, '').trim();
  normalized = normalized.replace(/\s{2,}/g, ' ').trim();
  for (const cat of categories) {
    if (normalized === cat.toLowerCase()) return cat;
    if (normalized.includes(cat.toLowerCase())) return cat;
  }
  return null;
}
function extractTaskText(input, category) {
  if (!category) return input.trim();
  const regex = new RegExp(`\\b${category}\\b[\\.\\!\\?\\s]*$`, 'i');
  return input.replace(regex, '').trim();
}

/** ----------- SPECIAL COMMANDS: EDIT/DELETE ----------- **/
function handleSpecialCommands(inputText) {
  // Delete task 3 from Home
  let m = inputText.match(/delete\s+task\s+(\d+)\s+from\s+(.+)/i);
  if (m) {
    const idx = parseInt(m[1], 10) - 1;
    const cat = extractValidCategory(m[2]);
    if (!cat) { alert("Couldn't determine category in delete command."); return true; }
    const tasks = JSON.parse(localStorage.getItem(cat)) || [];
    if (idx < 0 || idx >= tasks.length) { alert("Task number not found in " + cat); return true; }
    tasks.splice(idx, 1);
    saveTasks(cat, tasks);
    loadTasks();
    speakTextWithWebSpeech("Task deleted from " + cat);
    return true;
  }
  // Edit task 2 Home to ... Home (will update description)
  m = inputText.match(/edit\s+task\s+(\d+)\s+(\w+)\s+to\s+(.+)/i);
  if (m) {
    const idx = parseInt(m[1],10) - 1;
    const cat = extractValidCategory(m[2]);
    const newText = m[3].trim();
    if (!cat || !newText) { alert("Invalid edit command."); return true; }
    const tasks = JSON.parse(localStorage.getItem(cat)) || [];
    if (idx < 0 || idx >= tasks.length) { alert("Task number not found in " + cat); return true; }
    let parsedDate = chrono.parseDate(newText);
    tasks[idx] = { text: newText, date: parsedDate ? parsedDate.toISOString() : null };
    saveTasks(cat, tasks);
    loadTasks();
    speakTextWithWebSpeech("Task edited in " + cat);
    return true;
  }
  return false;
}
/** ----------- UNCHANGED ADD LOGIC ----------- **/
function addTask(inputText) {
  const cleaned = preprocessInput(inputText);
  const words = cleaned.trim().split(" ");
  let lastWord = words[words.length - 1];
  lastWord = lastWord.replace(/[.,!?;:]+$/, "");
  const category = extractValidCategory(lastWord);
  if (!category) {
    alert("Category not found at the end of the task. Please end your task with one of: " + categories.join(", "));
    return;
  }
  let taskText = words.slice(0, words.length - 1).join(" ").trim();
  taskText = taskText.replace(/[.,!?;:]+$/, "");
  if (!taskText) { alert("Task description is empty."); return; }
  let parsedDate = chrono.parseDate(taskText);
  const taskObj = { text: taskText, date: parsedDate ? parsedDate.toISOString() : null };
  saveTask(category, taskObj);
  loadTasks();
  speakTextWithWebSpeech("Task added to " + category);
}

/** ------------- UI / EVENTS / OTHERS ------------- **/
function tryAddOrSpecialCommand(inputText) {
  if (handleSpecialCommands(inputText)) return;
  addTask(inputText);
}
addManualBtn.onclick = () => {
  const inputText = manualInput.value;
  tryAddOrSpecialCommand(inputText);
  manualInput.value = "";
};

/** ------- REMAINING CODE (API, TTS Unlock, Backup, etc) ------- **/
// ... (All your existing backup/restore, playback, STT/gpt logic needs to go here - unchanged!)
// For brevity, retain from your file as-is. Only the blocks above needed changes.

/** Don't forget to call loadTasks() on page load **/
loadTasks();
</script>
</body>
</html>
