<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hands-Free Task Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/chrono-node@2.3.4/dist/chrono.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    .category { margin-top: 20px; }
    .category h3 { margin-bottom: 5px; }
    ul { list-style-type: none; padding-left: 0; }
    .task-row { display: flex; align-items: center; margin-bottom: 5px; }
    .task-text { flex: 1; }
    .task-controls button { margin-left: 4px; }
    .task-number { font-weight: bold; margin-right: 8px; }
    .date-badge {
      background: #e0e0e0;
      color: #333;
      border-radius: 3px;
      padding: 1px 6px;
      font-size: 12px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h2>üé§ Hands-Free Task Manager</h2>
  
  <div>
    <input type="text" id="manualInput" placeholder="Enter task (e.g. Buy milk Home)" style="width:80%;" />
    <button id="addManualBtn">Add Task</button>
  </div>

  <div id="transcript" style="margin-top:15px; white-space: pre-wrap;"></div>

  <button id="speakBtn">üéôÔ∏è Speak</button>

  <div id="categories">
    <div class="category" id="Home">
      <h3>Home</h3>
      <ul></ul>
    </div>
    <div class="category" id="Today">
      <h3>Today</h3>
      <ul></ul>
    </div>
    <div class="category" id="Urgent">
      <h3>Urgent</h3>
      <ul></ul>
    </div>
    <div class="category" id="Shop">
      <h3>Shop</h3>
      <ul></ul>
    </div>
  </div>

  <script>
    const categories = ["Home", "Today", "Urgent", "Shop"];

    function saveTasks(category, tasks) {
      localStorage.setItem(category, JSON.stringify(tasks));
    }

    function loadTasks() {
      categories.forEach(cat => {
        const tasks = JSON.parse(localStorage.getItem(cat)) || [];
        const ul = document.querySelector(`#${cat} ul`);
        ul.innerHTML = "";
        tasks.forEach((task, idx) => {
          const li = document.createElement("li");
          const row = document.createElement("div");
          row.className = "task-row";

          const numberSpan = document.createElement("span");
          numberSpan.className = "task-number";
          numberSpan.textContent = `${idx + 1}.`;

          const text = document.createElement("span");
          text.className = "task-text";
          text.textContent = task.text;

          if (task.date) {
            const date = new Date(task.date);
            const badge = document.createElement("span");
            badge.className = "date-badge";
            badge.textContent = date.toLocaleDateString();
            text.appendChild(badge);
          }

          row.appendChild(numberSpan);
          row.appendChild(text);
          li.appendChild(row);
          ul.appendChild(li);
        });
      });
    }

    function speakTextWithWebSpeech(text) {
      return new Promise(resolve => {
        const synth = window.speechSynthesis;
        const speak = () => {
          const utter = new SpeechSynthesisUtterance(text);
          const samantha = synth.getVoices().find(v => v.name.toLowerCase().includes("samantha"));
          utter.voice = samantha || null;
          synth.speak(utter);
          utter.onend = resolve;
        };
        if (synth.getVoices().length === 0) {
          synth.onvoiceschanged = speak;
        } else {
          speak();
        }
      });
    }

    function extractValidCategory(input) {
      const clean = input.toLowerCase().trim();
      return categories.find(cat => clean.includes(cat.toLowerCase()));
    }

    function parseDate(text) {
      const parsed = chrono.parseDate(text);
      return parsed ? parsed.toISOString() : null;
    }

    function handleSpecialCommands(inputText) {
      const deleteMatch = inputText.match(/delete task (\d+)\s+from\s+(.+)/i);
      if (deleteMatch) {
        const index = parseInt(deleteMatch[1], 10) - 1;
        const category = extractValidCategory(deleteMatch[2]);
        if (!category) return alert("Category not recognized.");
        const tasks = JSON.parse(localStorage.getItem(category)) || [];
        if (index < 0 || index >= tasks.length) return alert("Invalid task number.");
        tasks.splice(index, 1);
        saveTasks(category, tasks);
        loadTasks();
        speakTextWithWebSpeech("Task deleted from " + category);
        return true;
      }

      const editMatch = inputText.match(/edit task (\d+)\s+(\w+)\s+to\s+(.+)/i);
      if (editMatch) {
        const index = parseInt(editMatch[1], 10) - 1;
        const category = extractValidCategory(editMatch[2]);
        const newText = editMatch[3];
        if (!category || !newText) return alert("Invalid edit command.");
        const tasks = JSON.parse(localStorage.getItem(category)) || [];
        if (index < 0 || index >= tasks.length) return alert("Invalid task number.");
        tasks[index] = { text: newText.trim(), date: parseDate(newText) };
        saveTasks(category, tasks);
        loadTasks();
        speakTextWithWebSpeech("Task updated in " + category);
        return true;
      }

      return false;
    }

    function addTask(input) {
      const cleaned = input.trim();
      const words = cleaned.split(" ");
      const last = words[words.length - 1];
      const category = extractValidCategory(last);
      if (!category) return alert("Please end your task with a category like Home, Today, Urgent, or Shop.");
      const taskText = words.slice(0, words.length - 1).join(" ");
      if (!taskText) return alert("Task description missing.");
      const taskObj = { text: taskText.trim(), date: parseDate(taskText) };
      const tasks = JSON.parse(localStorage.getItem(category)) || [];
      tasks.push(taskObj);
      saveTasks(category, tasks);
      loadTasks();
      speakTextWithWebSpeech("Task added to " + category);
    }

    function tryAddOrSpecialCommand(text) {
      if (!text.trim()) return;
      if (handleSpecialCommands(text)) return;
      addTask(text);
    }

    function startVoiceInput() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();

      recognition.onstart = () => {
        transcript.textContent = "üéôÔ∏è Listening...";
      };

      recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript;
        transcript.textContent = `You said: ${spoken}`;
        tryAddOrSpecialCommand(spoken);
      };

      recognition.onerror = (event) => {
        transcript.textContent = "Error: " + event.error;
      };
    }

    document.getElementById("addManualBtn").onclick = () => {
      const input = document.getElementById("manualInput").value;
      tryAddOrSpecialCommand(input);
      document.getElementById("manualInput").value = "";
    };

    document.getElementById("speakBtn").onclick = () => {
      startVoiceInput();
    };

    loadTasks();
  </script>
</body>
</html>
